<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Fasilitas Publik Kota Malang</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }

        .legend-control {
            background: white;
            padding: 10px;
            font-size: 14px;
            line-height: 20px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            min-width: 220px;
            max-height: 400px;
            overflow-y: auto;
        }

        .legend-item {
            margin-bottom: 12px;
        }

        .legend-item img {
            display: block;
            margin-top: 5px;
            max-width: 100%;
            height: auto;
        }

        .opacity-slider {
            width: 100%;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

    var map = L.map('map').setView([-7.9666, 112.6326], 13);

    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    var googleStreets = L.tileLayer(
        'http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',
        { maxZoom:20, subdomains:['mt0','mt1','mt2','mt3'] }
    );

    var wmsUrl = "http://localhost:8080/geoserver/wms";

    function wmsLayer(layerName, opacity = 1) {
        return L.tileLayer.wms(wmsUrl, {
            layers: layerName,
            format: "image/png",
            transparent: true,
            version: "1.1.0",
            opacity: opacity
        });
    }

    var layerKota       = wmsLayer("uas_kota_malang:kota_malang");
    var layerKecamatan  = wmsLayer("uas_kota_malang:kecamatan_kota_malang");
    var layerKelurahan  = wmsLayer("uas_kota_malang:kelurahan_kota_malang");

    var radiusSekolah   = wmsLayer("uas_kota_malang:radius_sekolah1", 0.7);
    var radiusRS        = wmsLayer("uas_kota_malang:radius_rumah_sakit", 0.7);

    var titikSekolah    = wmsLayer("uas_kota_malang:school_kota_malang");
    var titikRS         = wmsLayer("uas_kota_malang:hospital_kota_malang");

    layerKota.addTo(map);
    layerKecamatan.addTo(map);
    layerKelurahan.addTo(map);
    radiusSekolah.addTo(map);
    radiusRS.addTo(map);
    titikSekolah.addTo(map);
    titikRS.addTo(map);

    var baseMaps = {
        "OpenStreetMap": osm,
        "Google Maps (Jalan)": googleStreets
    };

    var overlayMaps = {
        "Batas Kota Malang": layerKota,
        "Batas Kecamatan": layerKecamatan,
        "Batas Kelurahan": layerKelurahan,
        "Radius Sekolah": radiusSekolah,
        "Radius Rumah Sakit": radiusRS,
        "Lokasi Sekolah": titikSekolah,
        "Lokasi RS/Faskes": titikRS
    };

    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    var legend = L.control({ position: "topleft" });

    legend.onAdd = function () {
        var div = L.DomUtil.create("div", "legend-control");

        L.DomEvent.disableScrollPropagation(div);
        L.DomEvent.disableClickPropagation(div); 

        div.innerHTML = "<b>Legenda</b><br><hr style='margin: 5px 0;'>";

        Object.keys(overlayMaps).forEach(layerName => {
            let layer = overlayMaps[layerName];
            let wmsName = layer.wmsParams.layers;
            
            let legendUrl = `${wmsUrl}?service=WMS&request=GetLegendGraphic&format=image/png&layer=${wmsName}&transparent=true&LEGEND_OPTIONS=forceLabels:on;fontName:Arial;fontSize:11;fontAntiAliasing:true`;

            div.innerHTML += `
                <div class="legend-item">
                    <strong>${layerName}</strong>
                    <img src="${legendUrl}" alt="Legenda ${layerName}">
                </div>
            `;
        });

        return div;
    };

    legend.addTo(map);

    var opacityControl = L.control({ position: "topright" });

    opacityControl.onAdd = function () {
        var div = L.DomUtil.create("div", "legend-control");
        
        L.DomEvent.disableScrollPropagation(div);
        L.DomEvent.disableClickPropagation(div);

        div.innerHTML = "<b>Layer Opacity</b><br>";

        Object.keys(overlayMaps).forEach(layerName => {
            let layer = overlayMaps[layerName];
            let id = layerName.replace(/\s+/g, "_");

            div.innerHTML += `
                <div>
                    <label style="font-size:12px;">${layerName}</label><br>
                    <input type="range" min="0" max="1" step="0.1" value="${layer.options.opacity || 1}"
                        class="opacity-slider" 
                        id="op_${id}"
                        onchange="overlayMaps['${layerName}'].setOpacity(this.value)">
                </div><hr style="margin: 5px 0;">
            `;
        });

        return div;
    };

    opacityControl.addTo(map);

    map.on("click", function (e) {

        var targetLayers = [
            "uas_kota_malang:school_kota_malang",
            "uas_kota_malang:hospital_kota_malang",
            "uas_kota_malang:kecamatan_kota_malang",
            "uas_kota_malang:kelurahan_kota_malang"
        ].join(",");

        var url = getFeatureInfoUrl(wmsUrl, targetLayers, e.latlng, {
            info_format: "application/json",
            feature_count: 10
        });

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (!data.features.length) return;

                var f = data.features[0];
                var p = f.properties;

                var html = "<b>Info</b><br>";

                Object.keys(p).forEach(k => {
                    html += `<b>${k}</b>: ${p[k]}<br>`;
                });

                L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
            });
    });

    function getFeatureInfoUrl(baseUrl, layers, latlng, params) {
        var point = map.latLngToContainerPoint(latlng, map.getZoom());
        var size = map.getSize();

        var defaultParams = {
            request: "GetFeatureInfo",
            service: "WMS",
            srs: "EPSG:4326",
            styles: "",
            transparent: true,
            version: "1.1.0",
            format: "image/png",
            bbox: map.getBounds().toBBoxString(),
            height: size.y,
            width: size.x,
            layers: layers,
            query_layers: layers,
            info_format: "application/json"
        };

        params = L.extend(defaultParams, params || {});
        params["x"] = Math.round(point.x);
        params["y"] = Math.round(point.y);

        return baseUrl + L.Util.getParamString(params, baseUrl, true);
    }

</script>
</body>
</html>